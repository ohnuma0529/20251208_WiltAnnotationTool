# トマト萎れ定量化アノテーションツール (Tomato Wilt Annotation Tool)

本ツールは、トマトの萎凋病定量化のために設計された高度なアノテーション・追跡ツールです。**SAM 2 (Segment Anything Model 2)** による高精度なゼロショットセグメンテーションと、**CoTracker3** による堅牢な長期間ポイントトラッキング技術を組み合わせています。

## 主な機能

*   **ハイブリッドAIワークフロー**:
    *   **SAM 2**: ユーザーが指定するわずかな入力（Base点とTip点）から、高精度な葉のマスクを生成します。
    *   **CoTracker3**: 動画全体にわたり、キーポイント（Base, Tip, およびグリッド状のサポートポイント）を追跡します。
*   **広域N-way統合トラッキング (Global N-way Fusion)**:
    *   手動アノテーションを「キーフレーム」として扱うキーフレーム方式のトラッキングシステムを実装しています。
    *   中間フレームのトラッキング結果は、**過去・現在・未来のすべてのキーフレーム**からの予測結果を、距離に応じて重み付け統合して算出されます。これにより、フレームNでの修正が、フレームN-10やN+10の精度も向上させます。
*   **修正と改善**:
    *   **ドラッグ＆ドロップ修正**: 「Annotation Mode」でBase/Tip点をドラッグして簡単に位置を修正できます。
    *   **自動保存**: すべての変更は `annotation_state.json` に即座に保存されます。
    *   **厳密なBBox計算**: マスク形状や全ポイントを考慮したバウンディングボックス計算により、表示崩れを防ぎます。
    *   **外れ値除去**: サポートポイントが本体から乖離した場合、統計的フィルタ(V22)により自動的に削除されます。
    *   **フレーム削除の永続化**: "Truncate Future Frames" で削除したフレームは、リロード後も削除された状態が維持されます(V18)。
*   **データ管理**:
    *   階層的なデータ構造 (`Unit/Date/Images`) に対応しています。
    *   SSDキャッシュシステム（リサイズ画像のローカル保存）により、高速な画像読み込みを実現しています。
    *   `run_preload.sh` を使用して、全データを一括でキャッシュに事前読み込みできます(V23)。
    *   **データエクスポート**: YOLO形式(.zip)およびCSV形式(.csv)でのエクスポートに対応(V20)。

## システム要件

*   **OS**: Linux (Ubuntu推奨)
*   **GPU**: NVIDIA GPU (CUDA対応必須 - SAM 2 / CoTracker3 の動作に必要)
*   **Python**: 3.10以上
*   **Node.js**: 18以上

## セットアップと起動

1.  **バックエンドのセットアップ**:
    Conda環境 `WiltAnnotation` がバックエンドのランタイムとして設定されていることを確認してください。
    ```bash
    # バックエンドの起動 (ポート 8000)
    ./start_backend.sh
    ```

2.  **フロントエンドのセットアップ**:
    React + Vite ベースのプロジェクトです。
    ```bash
    # フロントエンドの起動 (ポート 5173 または 3000)
    ./start_frontend.sh
    ```

3.  **アクセス**:
    ブラウザで `http://localhost:5173` (またはターミナルに表示されたポート) を開いてください。

## アノテーション・ワークフロー

1.  **データ選択**: サイドバーから対象の「Unit」と「Date」を選択します。
2.  **アノテーションモード (Annotation Mode: ON)**:
    *   **描画**: 葉を囲むようにドラッグしてBBoxを作成します。Base点（青）とTip点（赤）が自動的に配置されます。
    *   **修正**: 既存のBase/Tip点をドラッグして位置を微調整します。
3.  **トラッキング (Tracking)**:
    *   最初のフレームでいくつかの葉をアノテーションします。
    *   **"Start Tracking"** をクリックします。システムが全フレームにわたって葉を追跡します。
    *   トラッキングがずれている未来のフレームまで移動します。
    *   **修正**: 点をドラッグして正しい位置に直します（これが新たなキーフレームになります）。
    *   再度 **"Start Tracking"** をクリックします。システムは最初のフレームと修正したフレームの両方をキーフレームとして利用し、間のフレームの軌跡を「Global N-way Fusion」により滑らかに補正します。

## アーキテクチャ

*   `backend/`: FastAPI サーバー。画像の読み込み、トラッキングロジック (`core/tracking.py`)、モデル推論を担当。
*   `frontend/`: React アプリケーション。UI、Canvas 描画 (`Viewer.tsx`)、状態管理 (`useAnnotation.ts`) を担当。
*   `fast_cache/`: リサイズされた画像をキャッシュし、読み込みを高速化するディレクトリ。
*   `brain/`: AIエージェントのメモリとログ。

## モデル

*   **SAM 2**: `backend/models/sam2` 経由でロード。
*   **CoTracker3**: `backend/co-tracker` 経由でロード。
